namespace = amaryllian
# Flags mod as present.
event = {
	id = amaryllian.0
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		set_global_flag = amaryllian_habitat_start_installed
	}
}

country_event = {
	id = amaryllian.5
	is_triggered_only = yes
	title = amaryllian_system_initializer_NAME
	desc = REQUIRES_DLC_WITH_NAME
	picture = GFX_evt_space_station
	show_sound = event_cityscape
	location = capital_scope
	option = {
		name = UTOPIA_TITLE
	}
	option = {
		name = FEDERATIONS_TITLE
	}
	option = {
		name = TOXOIDS_TITLE
	}
}

# Find habitat start empires.
event = {
	id = amaryllian.10
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = {
			limit = {
				amaryllian_is_habitat_start_dlc_present = yes
			}
			every_country = {
				limit = {
					exists = capital_scope
				}
				if = {
					limit = {
						has_country_flag = amaryllian_empire
					}
					capital_scope = {
						set_planet_name = "NAME_lotus"
					}
				}
				if = {
					limit = {
						capital_scope = {
							has_planet_flag = amaryllian_planet_start
						}
					}
					country_event = {
						id = amaryllian.11
					}
				}
			}
		}
		else = {
			set_global_flag = amaryllian_habitat_start_dlc_check_failed
			every_country = {
				limit = {
					has_country_flag = amaryllian_empire
				}
				if = {
					limit = {
						exists = capital_scope
					}
					capital_scope = {
						set_planet_name = "NAME_lotus"
					}
				}
			}
			every_country = {
				limit = {
					is_ai = no
				}
				country_event = {
					id = amaryllian.5
				}
			}
		}
	}
}

# Prepare habitat start system.
country_event = {
	id = amaryllian.11
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		capital_scope = {
			planet_event = {
				id = amaryllian.12
			}
			solar_system = {
				every_system_planet = {
					limit = {
						has_planet_flag = amaryllian_planet_barren
						any_moon = {
							has_planet_flag = amaryllian_planet_start
						}
					}
					set_planet_flag = has_megastructure
				}
			}
		}
	}
}

# Change habitat start planet to a habitat class.
planet_event = {
	id = amaryllian.12
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = {
			limit = {
				owner = {
					has_country_flag = amaryllian_empire
				}
			}
			set_planet_name = "NAME_lotus"
		}
		save_event_target_as = amaryllian_habitat_target
		clear_blockers = yes
		clear_deposits = yes
		set_planet_flag = megastructure
		set_planet_flag = habitat
		set_planet_flag = research_habitat
		set_planet_flag = amaryllian_habitat
		set_planet_flag = advanced_habitat
		set_planet_flag = advanced_habitat_2
		add_deposit = amaryllian_d_hab_building_slots_3
		set_planet_size = 10
		change_pc = pc_habitat
		set_planet_entity = {
			entity = "habitat_phase_03_entity"
			graphical_culture = owner
		}
		planet_event = {
			id = amaryllian.13
		}
	}
}

# Prepare habitat start planet.
planet_event = {
	id = amaryllian.13
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		# remove_all_buildings = yes	# We do not use this in case mods add starting buildings. Worst case better have it ruined than removed. This also keeps building_necrophage_elevation_chamber
		if = {
			limit = {
				owner = {
					is_regular_empire = yes
					is_lithoid_empire = no
					is_machine_empire = no
				}
			}
			remove_building = building_capital
			add_building = building_hab_major_capital
			remove_building = building_research_lab_1
			add_district = district_hab_housing
			add_district = district_hab_housing
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_science
			add_district = district_hab_commercial
			add_district = district_hab_cultural
			add_building = building_hydroponics_farm
			add_building = building_hydroponics_farm
			add_deposit = amaryllian_d_hab_minerals_1
			add_deposit = amaryllian_d_hab_energy_1
			add_deposit = amaryllian_d_hab_food_1
			add_deposit = d_hab_alloy_5
			check_planet_employment = yes
			break = yes
		}
		else_if = {
			limit = {
				owner = {
					is_lithoid_empire = yes
				}
				any_owned_pop = {
					is_lithoid = no
					is_organic_species = yes
				}
			}
			remove_building = building_capital
			add_building = building_hab_major_capital
			remove_building = building_research_lab_1
			add_district = district_hab_housing
			add_district = district_hab_housing
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_science
			add_district = district_hab_commercial
			add_district = district_hab_commercial
			add_district = district_hab_cultural
			add_building = building_hydroponics_farm
			add_building = building_hydroponics_farm
			add_building = building_mineral_purification_plant
			add_deposit = amaryllian_d_hab_minerals_1
			add_deposit = amaryllian_d_hab_energy_1
			add_deposit = d_hab_alloy_5
			check_planet_employment = yes
			break = yes
		}
		else_if = {
			limit = {
				owner = {
					is_lithoid_empire = yes
					is_hive_empire = no
				}
			}
			remove_building = building_capital
			add_building = building_hab_major_capital
			remove_building = building_research_lab_1
			add_district = district_hab_housing
			add_district = district_hab_housing
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_science
			add_district = district_hab_commercial
			add_district = district_hab_commercial
			add_district = district_hab_cultural
			add_building = building_mineral_purification_plant
			add_deposit = amaryllian_d_hab_minerals_1
			add_deposit = amaryllian_d_hab_energy_1
			add_deposit = d_hab_alloy_5
			check_planet_employment = yes
			break = yes
		}
		else_if = {
			limit = {
				owner = {
					is_lithoid_empire = yes
					is_hive_empire = yes
				}
			}
			remove_building = building_hive_capital
			add_building = building_hab_major_capital
			remove_building = building_research_lab_1
			add_district = district_hab_housing
			add_district = district_hab_housing
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_science
			add_district = district_hab_energy
			add_district = district_hab_energy
			add_district = district_hab_energy
			add_building = building_hive_node
			add_building = building_mineral_purification_plant
			add_deposit = amaryllian_d_hab_minerals_1
			add_deposit = amaryllian_d_hab_energy_1
			add_deposit = d_hab_alloy_5
			check_planet_employment = yes
			break = yes
		}
		else_if = {
			limit = {
				owner = {
					has_authority = auth_machine_intelligence
				}
				any_owned_pop = {
					is_lithoid = no
					is_organic_species = yes
				}
			}
			remove_building = building_machine_capital
			add_building = building_hab_major_capital
			remove_building = building_research_lab_1
			add_district = district_hab_housing
			add_district = district_hab_housing
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_science
			add_district = district_hab_energy
			add_district = district_hab_energy
			add_district = district_hab_energy
			add_building = building_hydroponics_farm
			add_building = building_hydroponics_farm
			add_building = building_maintenance_depot
			add_deposit = amaryllian_d_hab_minerals_1
			add_deposit = amaryllian_d_hab_energy_1
			add_deposit = d_hab_alloy_5
			check_planet_employment = yes
			break = yes
		}
		else_if = {
			limit = {
				owner = {
					has_authority = auth_machine_intelligence
				}
				any_owned_pop = {
					is_lithoid = yes
					is_organic_species = yes
				}
			}
			remove_building = building_machine_capital
			add_building = building_hab_major_capital
			remove_building = building_research_lab_1
			add_district = district_hab_housing
			add_district = district_hab_housing
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_science
			add_district = district_hab_energy
			add_district = district_hab_energy
			add_district = district_hab_energy
			add_building = building_drone_storage
			add_building = building_maintenance_depot
			add_deposit = amaryllian_d_hab_minerals_1
			add_deposit = amaryllian_d_hab_energy_1
			add_deposit = d_hab_alloy_5
			check_planet_employment = yes
			break = yes
		}
		else_if = {
			limit = {
				owner = {
					is_machine_empire = yes
				}
			}
			remove_building = building_machine_capital
			add_building = building_hab_major_capital
			remove_building = building_research_lab_1
			add_district = district_hab_housing
			add_district = district_hab_housing
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_science
			add_district = district_hab_energy
			add_district = district_hab_energy
			add_district = district_hab_energy
			add_building = building_uplink_node
			add_building = building_drone_storage
			add_deposit = amaryllian_d_hab_minerals_1
			add_deposit = amaryllian_d_hab_energy_1
			add_deposit = d_hab_alloy_5
			check_planet_employment = yes
			break = yes
		}
		else_if = {
			limit = {
				owner = {
					is_hive_empire = yes
					is_lithoid_empire = no
				}
			}
			remove_building = building_hive_capital
			add_building = building_hab_major_capital
			remove_building = building_research_lab_1
			add_district = district_hab_housing
			add_district = district_hab_housing
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_science
			add_district = district_hab_energy
			add_district = district_hab_energy
			add_building = building_hydroponics_farm
			add_building = building_hydroponics_farm
			add_deposit = amaryllian_d_hab_minerals_1
			add_deposit = amaryllian_d_hab_energy_1
			add_deposit = amaryllian_d_hab_food_1
			add_deposit = d_hab_alloy_5
			check_planet_employment = yes
			break = yes
		}
		else = {
			remove_building = building_capital
			add_building = building_hab_major_capital
			remove_building = building_research_lab_1
			add_district = district_hab_housing
			add_district = district_hab_housing
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_industrial
			add_district = district_hab_science
			add_district = district_hab_science
			add_district = district_hab_energy
			add_district = district_hab_energy
			add_building = building_hydroponics_farm
			add_building = building_hydroponics_farm
			add_deposit = amaryllian_d_hab_minerals_1
			add_deposit = amaryllian_d_hab_energy_1
			add_deposit = amaryllian_d_hab_food_1
			add_deposit = d_hab_alloy_5
			check_planet_employment = yes
			break = yes
		}
		owner = {
			if = {
				limit = {
					is_ai = yes
				}
				prev = {
					if = {
						limit = {
							has_building = building_commercial_zone
						}
						remove_building = building_commercial_zone
					}
					if = {
						limit = {
							has_building = building_autochthon_monument
						}
						remove_building = building_autochthon_monument
					}
					if = {
						limit = {
							has_building = building_bureaucratic_1
						}
						remove_building = building_bureaucratic_1
					}
					if = {
						limit = {
							has_building = building_temple
						}
						remove_building = building_temple
					}
					if = {
						limit = {
							has_building = building_hive_node
						}
						remove_building = building_hive_node
					}
					if = {
						limit = {
							has_building = building_uplink_node
						}
						remove_building = building_uplink_node
					}
					if = {
						limit = {
							has_building = building_uplink_node
						}
						remove_building = building_uplink_node
					}
				}
			}
			country_event = {
				id = amaryllian.60
				days = 2
			}
		}
	}
}

# Find amaryllian countries to give starting tech.
event = {
	id = amaryllian.20
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		every_country = {
			limit = {
				OR = {
					has_civic = civic_amaryllian_habitat
					exists = capital_scope
				}
			}
			if = {
				limit = {
					capital_scope = {
						has_planet_flag = amaryllian_planet_start
					}
				}
				country_event = {
					id = amaryllian.21
				}
			}
		}
	}
}

# Give starting tech to amaryllian country.
country_event = {
	id = amaryllian.21
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = {
			limit = {
				amaryllian_is_habitat_start_dlc_present = yes
			}
			give_technology = {
				message = yes
				tech = tech_habitat_1
			}
		}
		if = {
			limit = {
				is_lithoid_empire = yes
			}
			give_technology = {
				message = yes
				tech = tech_mineral_purification_1
			}
		}
		if = {
			limit = {
				any_owned_pop = {
					is_lithoid = no
					is_organic_species = yes
				}
			}
			give_technology = {
				message = yes
				tech = tech_hydroponics
			}
		}
	}
}

# Change habitability for amaryllian primary species.
event = {
	id = amaryllian.30
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		every_country = {
			limit = {
				has_civic = civic_amaryllian_habitat
				exists = capital_scope
			}
			if = {
				limit = {
					amaryllian_is_habitat_start_dlc_present = yes
					amaryllian_habitability_change_allowed = yes
				}
				country_event = {
					id = amaryllian.31
				}
			}
		}
	}
}

# Change habitability - primary.
country_event = {
	id = amaryllian.31
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		every_owned_pop = {
			limit = {
				is_same_species = root
				NOT = {
					pop_has_trait = trait_pc_habitat_preference
				}
				is_organic_species = yes
			}
			set_pop_flag = amaryllian_pop			# For debug purposes.
			modify_species = {
				species = this
				ideal_planet_class = pc_habitat
				add_trait = trait_void_dweller_1
			}
			root = {
				change_dominant_species = {
					species = prev
				}
			}
		}
	}
}

# Change habitability for amaryllian seconday species.
event = {
	id = amaryllian.40
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		every_country = {
			limit = {
				has_civic = civic_amaryllian_habitat
				exists = capital_scope
			}
			if = {
				limit = {
					amaryllian_is_habitat_start_dlc_present = yes
					amaryllian_habitability_change_allowed = yes
				}
				country_event = {
					id = amaryllian.41
				}
			}
		}
	}
}

# Change habitability - secondary.
country_event = {
	id = amaryllian.41
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		every_owned_pop = {
			limit = {
				NOR = {
					is_same_species = root
					pop_has_trait = trait_pc_habitat_preference
				}
				OR = {
					is_organic_species = yes
					is_lithoid = yes
				}
			}
			modify_species = {
				species = this
				ideal_planet_class = pc_habitat
				add_trait = trait_void_dweller_1
			}
			set_citizenship_type = {
				type = citizenship_assimilation
			}
		}
	}
}

# NO LONGER IN USE. Keeping for save backwards compatibility.
# Give civic jobs and ascension perk modifier with delay. Called from on_yearly_pulse_country.
country_event = {
	id = amaryllian.50
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		OR = {
			has_civic = civic_amaryllian_habitat
			has_ascension_perk = ap_amaryllian_voidchildren
		}
	}
	immediate = {
		country_event = {
			id = amaryllian.51
			days = 4
		}
	}
}

# on_game_start_country
# on_post_government_changed
# on_ascension_perk_picked
# Give civic jobs and ascension perk modifier.
country_event = {
	id = amaryllian.51
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		OR = {
			has_civic = civic_amaryllian_habitat
			has_ascension_perk = ap_amaryllian_voidchildren
		}
	}
	immediate = {
		if = {
			limit = {
				is_gestalt = no
			}
			every_owned_planet = {
				limit = {
					amaryllian_is_valid_voidchildren_planet = yes
				}
				if = {
					limit = {
						root = {
							has_civic = civic_amaryllian_habitat
						}
						NOT = {
							has_modifier = amaryllian_habitat_captain_quarters
						}
					}
					add_modifier = {
						modifier = amaryllian_habitat_captain_quarters
						clear_on_owner_change = yes
					}
					check_planet_employment = yes
				}
				if = {
					limit = {
						root = {
							has_ascension_perk = ap_amaryllian_voidchildren
						}
						NOT = {
							has_modifier = amaryllian_voidchildren_habitat_modifier
						}
					}
					add_modifier = {
						modifier = amaryllian_voidchildren_habitat_modifier
						clear_on_owner_change = yes
					}
				}
			}
		}
		else = {
			every_owned_planet = {
				limit = {
					amaryllian_is_valid_voidchildren_planet = yes
				}
				if = {
					limit = {
						root = {
							has_civic = civic_amaryllian_habitat
						}
						NOT = {
							has_modifier = amaryllian_habitat_brain_quarters
						}
					}
					add_modifier = {
						modifier = amaryllian_habitat_brain_quarters
						clear_on_owner_change = yes
					}
					check_planet_employment = yes
				}
				if = {
					limit = {
						root = {
							has_ascension_perk = ap_amaryllian_voidchildren
						}
						NOT = {
							has_modifier = amaryllian_voidchildren_habitat_modifier
						}
					}
					add_modifier = {
						modifier = amaryllian_voidchildren_habitat_modifier
						clear_on_owner_change = yes
					}
				}
			}
		}
		country_event = {
			id = amaryllian.60
			days = 1
		}
	}
}

# Remove unity bonus from invalid countries.
event = {
	id = amaryllian.52
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		every_country = {
			limit = {
				NOT = {
					has_civic = civic_amaryllian_habitat
				}
			}
			every_owned_planet = {
				remove_modifier = amaryllian_habitat_captain_quarters
				remove_modifier = amaryllian_habitat_brain_quarters
			}
		}
	}
}

# Give civic jobs - planet
planet_event = {
	id = amaryllian.53
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		owner = {
			has_civic = civic_amaryllian_habitat
		}
	}
	immediate = {
		if = {
			limit = {
				amaryllian_is_valid_voidchildren_planet = yes
			}
			if = {
				limit = {
					owner = {
						is_gestalt = no
					}
				}
				if = {
					limit = {
						NOT = {
							has_modifier = amaryllian_habitat_captain_quarters
						}
					}
					add_modifier = {
						modifier = amaryllian_habitat_captain_quarters
						clear_on_owner_change = yes
					}
					check_planet_employment = yes
				}
				if = {
					limit = {
						owner = {
							has_ascension_perk = ap_amaryllian_voidchildren
						}
						NOT = {
							has_modifier = amaryllian_voidchildren_habitat_modifier
						}
					}
					add_modifier = {
						modifier = amaryllian_voidchildren_habitat_modifier
						clear_on_owner_change = yes
					}
				}
			}
			else = {
				if = {
					limit = {
						NOT = {
							has_modifier = amaryllian_habitat_brain_quarters
						}
					}
					add_modifier = {
						modifier = amaryllian_habitat_brain_quarters
						clear_on_owner_change = yes
					}
					check_planet_employment = yes
				}
				if = {
					limit = {
						owner = {
							has_ascension_perk = ap_amaryllian_voidchildren
						}
						NOT = {
							has_modifier = amaryllian_voidchildren_habitat_modifier
						}
					}
					add_modifier = {
						modifier = amaryllian_voidchildren_habitat_modifier
						clear_on_owner_change = yes
					}
				}
			}
			owner = {
				country_event = {
					id = amaryllian.60					# Apply unity bonus.
					days = 2
				}
			}
		}
	}
}

country_event = {
	id = amaryllian.54
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		every_owned_planet = {
			check_planet_employment = yes
		}
	}
}

# Apply unity bonus. (called from amaryllian.60)
country_event = {
	id = amaryllian.60
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_civic = civic_amaryllian_habitat
	}
	immediate = {
		if = {
			limit = {
				is_gestalt = no
			}
			export_trigger_value_to_variable = {
				trigger = num_assigned_jobs
				variable = var_num_amaryllian_habitat
				parameters = {
					job = amaryllian_habitat_captain
				}
			}
			remove_modifier = amaryllian_unity_1
			add_modifier = {
				modifier = amaryllian_unity_1
				multiplier = var_num_amaryllian_habitat
			}
		}
		else = {
			export_trigger_value_to_variable = {
				trigger = num_assigned_jobs
				variable = var_num_amaryllian_habitat
				parameters = {
					job = amaryllian_habitat_brain
				}
			}
			remove_modifier = amaryllian_gestalt_unity_1
			add_modifier = {
				modifier = amaryllian_gestalt_unity_1
				multiplier = var_num_amaryllian_habitat
			}
		}
	}
}

# Remove unity bonus from invalid countries.
event = {
	id = amaryllian.61
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		every_country = {
			limit = {
				NOT = {
					has_civic = civic_amaryllian_habitat
				}
			}
			remove_modifier = amaryllian_unity_1
			remove_modifier = amaryllian_gestalt_unity_1
		}
	}
}

# Give research options to AP Voidborne owner.
country_event = {
	id = amaryllian.70
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_civic = civic_amaryllian_habitat
		NOT = {
			has_country_flag = amaryllian_research_option_added
		}
	}
	immediate = {
		if = {
			limit = {
				OR = {
					has_ascension_perk = ap_voidborn
					num_ascension_perks > 1
				}
			}
			set_country_flag = amaryllian_research_option_added
			if = {
				limit = {
					NOT = {
						has_technology = amaryllian_tech_habitat_arcology
					}
				}
				give_technology = {
					tech = amaryllian_tech_habitat_arcology
					message = yes
				}
			}
			add_research_option = amaryllian_tech_arms_industry
			add_research_option = amaryllian_tech_civilian_industry
			add_research_option = amaryllian_tech_farming_industry
			add_research_option = amaryllian_tech_fortress_industry
			add_research_option = amaryllian_tech_research_industry
			add_research_option = amaryllian_tech_bureaucratic_industry
			add_research_option = amaryllian_tech_refinery_industry
			add_research_option = amaryllian_tech_trade_industry
			add_research_option = amaryllian_tech_mining_industry
			add_research_option = amaryllian_tech_generator_industry
			add_research_option = amaryllian_tech_storage_industry
			if = {
				limit = {
					has_valid_civic = civic_machine_servitor
				}
				add_research_option = amaryllian_tech_sanctuary_industry
			}
		}
	}
}

# Recalculate Habitat Storage Districts modifier. on_action district changed.
planet_event = {
	id = amaryllian.80
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		last_district_changed = amaryllian_district_arcology_storage_industry
	}
	immediate = {
		owner = {
			amaryllian_recalculate_country_storage_modifier = yes
		}
	}
}

# Recalculate Habitat Storage Districts modifier. on_action planet swapped.
planet_event = {
	id = amaryllian.81
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_planet_flag = amaryllian_storage_arcology
	}
	immediate = {
		owner = {
			amaryllian_recalculate_country_storage_modifier = yes
		}
	}
}

# Recalculate Habitat Storage Districts modifier. Sanitiser.
country_event = {
	id = amaryllian.82
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		amaryllian_recalculate_country_storage_modifier = yes
	}
}

# Habitat arcology complete
planet_event = {
	id = amaryllian.199
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = {
			limit = {
				has_planet_flag = amaryllian_hab_grand_arcology
				NOT = {
					has_planet_flag = amaryllian_hab_arcology
				}
			}
			if = {
				limit = {
					is_capital = no
				}
				set_colony_type = amaryllian_col_grand_habitat_arcology
			}
			planet_event = {
				id = amaryllian.220
			}
		}
		if = {
			limit = {
				has_planet_flag = amaryllian_hab_arcology
				has_planet_flag = amaryllian_civilian_arcology
				NOT = {
					has_planet_flag = amaryllian_hab_grand_arcology
				}
			}
			if = {
				limit = {
					is_capital = no
					is_planet_class = pc_habitat
				}
				set_colony_type = col_habitat_factory
			}
			if = {
				limit = {
					is_capital = no
					is_pd_planetary_habitat = yes
				}
				set_colony_type = col_dome_factory
			}
			planet_event = {
				id = amaryllian.200
			}
		}
		if = {
			limit = {
				has_planet_flag = amaryllian_hab_arcology
				has_planet_flag = amaryllian_arms_arcology
				NOT = {
					has_planet_flag = amaryllian_hab_grand_arcology
				}
			}
			if = {
				limit = {
					is_capital = no
					is_planet_class = pc_habitat
				}
				set_colony_type = col_habitat_foundry
			}
			if = {
				limit = {
					is_capital = no
					is_pd_planetary_habitat = yes
				}
				set_colony_type = col_dome_foundry
			}
			planet_event = {
				id = amaryllian.201
			}
		}
		if = {
			limit = {
				has_planet_flag = amaryllian_hab_arcology
				has_planet_flag = amaryllian_farming_arcology
				NOT = {
					has_planet_flag = amaryllian_hab_grand_arcology
				}
			}
			if = {
				limit = {
					is_capital = no
					#	is_planet_class = pc_habitat
				}
				set_colony_type = amaryllian_col_habitat_farming
			}
			planet_event = {
				id = amaryllian.202
			}
		}
		if = {
			limit = {
				has_planet_flag = amaryllian_hab_arcology
				has_planet_flag = amaryllian_fortress_arcology
				NOT = {
					has_planet_flag = amaryllian_hab_grand_arcology
				}
			}
			if = {
				limit = {
					is_capital = no
					is_planet_class = pc_habitat
				}
				set_colony_type = col_habitat_fortress
			}
			if = {
				limit = {
					is_capital = no
					is_pd_planetary_habitat = yes
				}
				set_colony_type = col_dome_fortress
			}
			planet_event = {
				id = amaryllian.203
			}
		}
		if = {
			limit = {
				has_planet_flag = amaryllian_hab_arcology
				has_planet_flag = amaryllian_research_arcology
				NOT = {
					has_planet_flag = amaryllian_hab_grand_arcology
				}
			}
			if = {
				limit = {
					is_capital = no
					is_planet_class = pc_habitat
				}
				set_colony_type = col_habitat_research
			}
			if = {
				limit = {
					is_capital = no
					is_pd_planetary_habitat = yes
				}
				set_colony_type = col_dome_research
			}
			planet_event = {
				id = amaryllian.204
			}
		}
		if = {
			limit = {
				has_planet_flag = amaryllian_hab_arcology
				has_planet_flag = amaryllian_bureaucratic_arcology
				NOT = {
					has_planet_flag = amaryllian_hab_grand_arcology
				}
			}
			if = {
				limit = {
					is_capital = no
					#	is_planet_class = pc_habitat
				}
				set_colony_type = col_bureau
			}
			planet_event = {
				id = amaryllian.205
			}
		}
		if = {
			limit = {
				has_planet_flag = amaryllian_hab_arcology
				has_planet_flag = amaryllian_refinery_arcology
				NOT = {
					has_planet_flag = amaryllian_hab_grand_arcology
				}
			}
			if = {
				limit = {
					is_capital = no
					is_planet_class = pc_habitat
				}
				set_colony_type = col_habitat_refinery
			}
			if = {
				limit = {
					is_capital = no
					is_pd_planetary_habitat = yes
				}
				set_colony_type = col_dome_refinery
			}
			planet_event = {
				id = amaryllian.206
			}
		}
		if = {
			limit = {
				has_planet_flag = amaryllian_hab_arcology
				has_planet_flag = amaryllian_trade_arcology
				NOT = {
					has_planet_flag = amaryllian_hab_grand_arcology
				}
			}
			if = {
				limit = {
					is_capital = no
					is_planet_class = pc_habitat
				}
				set_colony_type = col_habitat_trade
			}
			if = {
				limit = {
					is_capital = no
					is_pd_planetary_habitat = yes
				}
				set_colony_type = col_dome_trade
			}
			planet_event = {
				id = amaryllian.207
			}
		}
		if = {
			limit = {
				has_planet_flag = amaryllian_hab_arcology
				has_planet_flag = amaryllian_mining_arcology
				NOT = {
					has_planet_flag = amaryllian_hab_grand_arcology
				}
			}
			if = {
				limit = {
					is_capital = no
					#	is_planet_class = pc_habitat
				}
				set_colony_type = amaryllian_col_habitat_mining
			}
			planet_event = {
				id = amaryllian.208
			}
		}
		if = {
			limit = {
				has_planet_flag = amaryllian_hab_arcology
				has_planet_flag = amaryllian_generator_arcology
				NOT = {
					has_planet_flag = amaryllian_hab_grand_arcology
				}
			}
			if = {
				limit = {
					is_capital = no
					#	is_planet_class = pc_habitat
				}
				set_colony_type = amaryllian_col_habitat_generator
			}
			planet_event = {
				id = amaryllian.209
			}
		}
		if = {
			limit = {
				has_planet_flag = amaryllian_hab_arcology
				has_planet_flag = amaryllian_sanctuary_arcology
				NOT = {
					has_planet_flag = amaryllian_hab_grand_arcology
				}
			}
			if = {
				limit = {
					is_capital = no
					#	is_planet_class = pc_habitat
				}
				set_colony_type = amaryllian_col_habitat_sanctuary
			}
			planet_event = {
				id = amaryllian.210
			}
		}
		else = {
			break = yes
		}
	}
}

planet_event = {
	id = amaryllian.200
	title = amaryllian.200.name
	desc = amaryllian.200.desc
	picture = GFX_evt_tradestation_interior
	show_sound = event_cityscape
	location = root
	is_triggered_only = yes
	# trigger = {
	# 	is_planet_class = pc_habitat
	# 	has_planet_flag = amaryllian_civilian_arcology
	# }
	option = {
		name = amaryllian.200.a
	}
}

planet_event = {
	id = amaryllian.201
	title = amaryllian.201.name
	desc = amaryllian.201.desc
	picture = GFX_evt_space_hangar
	show_sound = event_cityscape
	location = root
	is_triggered_only = yes
	# trigger = {
	# 	is_planet_class = pc_habitat
	# 	has_planet_flag = amaryllian_arms_arcology
	# }
	option = {
		name = amaryllian.201.a
	}
}

planet_event = {
	id = amaryllian.202
	title = amaryllian.202.name
	desc = amaryllian.202.desc
	picture = GFX_evt_baol_ruins
	show_sound = event_cityscape
	location = root
	is_triggered_only = yes
	# trigger = {
	# 	is_planet_class = pc_habitat
	# 	has_planet_flag = amaryllian_farming_arcology
	# }
	option = {
		name = amaryllian.202.a
	}
}

planet_event = {
	id = amaryllian.203
	title = amaryllian.203.name
	desc = amaryllian.203.desc
	picture = GFX_evt_space_station
	show_sound = event_cityscape
	location = root
	is_triggered_only = yes
	# trigger = {
	# 	is_planet_class = pc_habitat
	# 	has_planet_flag = amaryllian_fortress_arcology
	# }
	option = {
		name = amaryllian.203.a
	}
}

planet_event = {
	id = amaryllian.204
	title = amaryllian.204.name
	desc = amaryllian.204.desc
	picture = GFX_evt_physics_research
	show_sound = event_cityscape
	location = root
	is_triggered_only = yes
	# trigger = {
	# 	is_planet_class = pc_habitat
	# 	has_planet_flag = amaryllian_research_arcology
	# }
	option = {
		name = amaryllian.204.a
	}
}

planet_event = {
	id = amaryllian.205
	title = amaryllian.205.name
	desc = amaryllian.205.desc
	picture = GFX_evt_galactic_market
	show_sound = event_cityscape
	location = root
	is_triggered_only = yes
	# trigger = {
	# 	is_planet_class = pc_habitat
	# 	has_planet_flag = amaryllian_bureaucratic_arcology
	# }
	option = {
		name = amaryllian.205.a
	}
}

planet_event = {
	id = amaryllian.206
	title = amaryllian.206.name
	desc = amaryllian.206.desc
	picture = GFX_evt_ship_offloading_cargo
	show_sound = event_cityscape
	location = root
	is_triggered_only = yes
	# trigger = {
	# 	is_planet_class = pc_habitat
	# 	has_planet_flag = amaryllian_refinery_arcology
	# }
	option = {
		name = amaryllian.206.a
	}
}

planet_event = {
	id = amaryllian.207
	title = amaryllian.207.name
	desc = amaryllian.207.desc
	picture = GFX_evt_financial_instruments
	show_sound = event_cityscape
	location = root
	is_triggered_only = yes
	# trigger = {
	# 	is_planet_class = pc_habitat
	# 	has_planet_flag = amaryllian_trade_arcology
	# }
	option = {
		name = amaryllian.207.a
	}
}

planet_event = {
	id = amaryllian.208
	title = amaryllian.208.name
	desc = amaryllian.208.desc
	picture = GFX_evt_resource_cache
	show_sound = event_cityscape
	location = root
	is_triggered_only = yes
	# trigger = {
	# 	is_planet_class = pc_habitat
	# 	has_planet_flag = amaryllian_mining_arcology
	# }
	option = {
		name = amaryllian.208.a
	}
}

planet_event = {
	id = amaryllian.209
	title = amaryllian.209.name
	desc = amaryllian.209.desc
	picture = GFX_evt_ancient_databank
	show_sound = event_cityscape
	location = root
	is_triggered_only = yes
	# trigger = {
	# 	is_planet_class = pc_habitat
	# 	has_planet_flag = amaryllian_generator_arcology
	# }
	option = {
		name = amaryllian.209.a
	}
}

planet_event = {
	id = amaryllian.210
	title = amaryllian.210.name
	desc = amaryllian.210.desc
	picture = GFX_evt_arena
	show_sound = event_cityscape
	location = root
	is_triggered_only = yes
	# trigger = {
	# 	is_planet_class = pc_habitat
	# 	has_planet_flag = amaryllian_sanctuary_arcology
	# }
	option = {
		name = amaryllian.210.a
	}
}

planet_event = {
	id = amaryllian.211
	title = amaryllian.211.name
	desc = amaryllian.211.desc
	picture = GFX_evt_cargoship_caravan
	show_sound = event_cityscape
	location = root
	is_triggered_only = yes
	# trigger = {
	# 	is_planet_class = pc_habitat
	# 	has_planet_flag = amaryllian_storage_arcology
	# }
	option = {
		name = amaryllian.211.a
	}
}

planet_event = {
	id = amaryllian.220
	title = amaryllian.220.name
	desc = amaryllian.220.desc
	picture = GFX_evt_metropolis
	show_sound = event_cityscape
	location = root
	is_triggered_only = yes
	# trigger = {
	# 	is_planet_class = pc_habitat
	# 	has_planet_flag = amaryllian_hab_grand_arcology
	# }
	option = {
		name = amaryllian.220.a
	}
}

# Planetary Diversity - Planetary habitat compatibility
planet_event = {
	id = amaryllian.800
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		if = {
			limit = {
				OR = {
					has_planet_flag = amaryllian_arms_arcology
					has_planet_flag = amaryllian_civilian_arcology
					has_planet_flag = amaryllian_arms_arcology
					has_planet_flag = amaryllian_farming_arcology
					has_planet_flag = amaryllian_fortress_arcology
					has_planet_flag = amaryllian_research_arcology
					has_planet_flag = amaryllian_bureaucratic_arcology
					has_planet_flag = amaryllian_refinery_arcology
					has_planet_flag = amaryllian_trade_arcology
					has_planet_flag = amaryllian_mining_arcology
					has_planet_flag = amaryllian_generator_arcology
					has_planet_flag = amaryllian_sanctuary_arcology
					has_planet_flag = amaryllian_storage_arcology_setup
					has_planet_flag = amaryllian_hab_arcology
					has_planet_flag = amaryllian_hab_grand_arcology
				}
				NOT = {
					# In case any smartbum mod adds terraforming to a habitat.
					uses_district_set = habitat
				}
			}
			add_modifier = {
				modifier = amaryllian_pd_hab_postterraform
				days = 32
			}
			remove_modifier = amaryllian_voidchildren_habitat_modifier
			remove_modifier = amaryllian_decision_arcology_project_modifier
			remove_modifier = amaryllian_habitat_captain_quarters
			remove_modifier = amaryllian_habitat_brain_quarters
			remove_planet_flag = amaryllian_arms_arcology
			remove_planet_flag = amaryllian_civilian_arcology
			remove_planet_flag = amaryllian_farming_arcology
			remove_planet_flag = amaryllian_fortress_arcology
			remove_planet_flag = amaryllian_research_arcology
			remove_planet_flag = amaryllian_bureaucratic_arcology
			remove_planet_flag = amaryllian_refinery_arcology
			remove_planet_flag = amaryllian_trade_arcology
			remove_planet_flag = amaryllian_mining_arcology
			remove_planet_flag = amaryllian_generator_arcology
			remove_planet_flag = amaryllian_sanctuary_arcology
			remove_planet_flag = amaryllian_storage_arcology
			remove_planet_flag = amaryllian_hab_arcology
			remove_planet_flag = amaryllian_hab_grand_arcology
			remove_planet_flag = amaryllian_arms_arcology_setup
			remove_planet_flag = amaryllian_civilian_arcology_setup
			remove_planet_flag = amaryllian_farming_arcology_setup
			remove_planet_flag = amaryllian_fortress_arcology_setup
			remove_planet_flag = amaryllian_research_arcology_setup
			remove_planet_flag = amaryllian_bureaucratic_arcology_setup
			remove_planet_flag = amaryllian_refinery_arcology_setup
			remove_planet_flag = amaryllian_trade_arcology_setup
			remove_planet_flag = amaryllian_mining_arcology_setup
			remove_planet_flag = amaryllian_generator_arcology_setup
			remove_planet_flag = amaryllian_sanctuary_arcology_setup
			remove_planet_flag = amaryllian_storage_arcology_setup
			remove_planet_flag = amaryllian_hab_arcology_setup
			remove_planet_flag = amaryllian_hab_grand_arcology_setup
			set_variable = {
				which = "amaryllian_arcology_setup_num"
				value = 0
			}
		}
	}
}

planet_event = {
	id = amaryllian.801
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		remove_modifier = amaryllian_habitat_captain_quarters
		remove_modifier = amaryllian_habitat_brain_quarters
	}
}

# Apply or remove civic bonuses on owner change.
#From = Country scope (new owner)
#This = Planet scope
planet_event = {
	id = amaryllian.802
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		OR = {
			owner = {
				has_civic = civic_amaryllian_habitat
			}
			from = {
				has_civic = civic_amaryllian_habitat
			}
		}
	}
	immediate = {
		# Both countries have civic.
		if = {
			limit = {
				owner = {
					has_civic = civic_amaryllian_habitat
				}
				from = {
					has_civic = civic_amaryllian_habitat
				}
			}
			if = {
				limit = {
					amaryllian_is_valid_voidchildren_planet = yes
				}
				if = {
					limit = {
						from = {
							is_gestalt = no
						}
					}
					if = {
						limit = {
							NOT = {
								has_modifier = amaryllian_habitat_captain_quarters
							}
						}
						remove_modifier = amaryllian_habitat_brain_quarters
						add_modifier = {
							modifier = amaryllian_habitat_captain_quarters
							clear_on_owner_change = yes
						}
						check_planet_employment = yes
					}
				}
				else = {
					if = {
						limit = {
							NOT = {
								has_modifier = amaryllian_habitat_brain_quarters
							}
						}
						remove_modifier = amaryllian_habitat_captain_quarters
						add_modifier = {
							modifier = amaryllian_habitat_brain_quarters
							clear_on_owner_change = yes
						}
						check_planet_employment = yes
					}
				}
				owner = {
					country_event = {
						id = amaryllian.60
						days = 2
					}
				}
				from = {
					country_event = {
						id = amaryllian.60
						days = 2
					}
				}
			}
		}
		# New owner has civic.
		else_if = {
			limit = {
				from = {
					has_civic = civic_amaryllian_habitat
				}
				owner = {
					NOT = {
						has_civic = civic_amaryllian_habitat
					}
				}
			}
			if = {
				limit = {
					amaryllian_is_valid_voidchildren_planet = yes
				}
				if = {
					limit = {
						from = {
							is_gestalt = no
						}
					}
					if = {
						limit = {
							NOT = {
								has_modifier = amaryllian_habitat_captain_quarters
							}
						}
						remove_modifier = amaryllian_habitat_brain_quarters
						add_modifier = {
							modifier = amaryllian_habitat_captain_quarters
							clear_on_owner_change = yes
						}
						check_planet_employment = yes
					}
				}
				else = {
					if = {
						limit = {
							NOT = {
								has_modifier = amaryllian_habitat_brain_quarters
							}
						}
						remove_modifier = amaryllian_habitat_captain_quarters
						add_modifier = {
							modifier = amaryllian_habitat_brain_quarters
							clear_on_owner_change = yes
						}
						check_planet_employment = yes
					}
				}
				from = {
					country_event = {
						id = amaryllian.60						# Apply unity bonus.
						days = 2
					}
				}
			}
		}
		# Former owner has civic.
		else_if = {
			limit = {
				from = {
					NOT = {
						has_civic = civic_amaryllian_habitat
					}
				}
				owner = {
					has_civic = civic_amaryllian_habitat
				}
			}
			remove_modifier = amaryllian_habitat_captain_quarters
			remove_modifier = amaryllian_habitat_brain_quarters
			owner = {
				country_event = {
					id = amaryllian.60					# Apply unity bonus.
					days = 2
				}
			}
		}
	}
}

# Grand Arcology designer
planet_event = {
	id = amaryllian.900
	title = amaryllian.900.name
	desc = amaryllian.900.desc
	picture = GFX_evt_ancient_databank
	location = root
	is_triggered_only = yes
	#	arms
	option = {
		name = amaryllian.900.a
		allow = {
			custom_tooltip_fail = {
				text = amaryllian_decision_grand_arcology_project_queued
				NOT = {
					has_planet_flag = amaryllian_decision_grand_arcology_project_queued
				}
			}
		}
		hidden_effect = {
			if = {
				limit = {
					NOR = {
						has_planet_flag = amaryllian_decision_grand_arcology_designer_locked
						check_variable = {
							which = "amaryllian_arcology_setup_num"
							value >= 4
						}
						has_planet_flag = amaryllian_arms_arcology_setup
					}
					OR = {
						has_planet_flag = amaryllian_arms_arcology
						owner = {
							has_technology = amaryllian_tech_arms_industry
						}
					}
				}
				set_planet_flag = amaryllian_arms_arcology_setup
				change_variable = {
					which = amaryllian_arcology_setup_num
					value = 1
				}
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
			else = {
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
		}
	}
	#	civilian
	option = {
		name = amaryllian.900.b
		trigger = {
			OR = {
				has_planet_flag = amaryllian_civilian_arcology
				owner = {
					OR = {
						is_gestalt = no
						has_valid_civic = civic_machine_servitor
					}
				}
			}
		}
		allow = {
			custom_tooltip_fail = {
				text = amaryllian_decision_grand_arcology_project_queued
				NOT = {
					has_planet_flag = amaryllian_decision_grand_arcology_project_queued
				}
			}
		}
		hidden_effect = {
			if = {
				limit = {
					NOR = {
						has_planet_flag = amaryllian_decision_grand_arcology_designer_locked
						check_variable = {
							which = "amaryllian_arcology_setup_num"
							value >= 4
						}
						has_planet_flag = amaryllian_civilian_arcology_setup
					}
					OR = {
						has_planet_flag = amaryllian_civilian_arcology
						owner = {
							has_technology = amaryllian_tech_civilian_industry
						}
					}
				}
				set_planet_flag = amaryllian_civilian_arcology_setup
				change_variable = {
					which = amaryllian_arcology_setup_num
					value = 1
				}
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
			else = {
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
		}
	}
	#	farming
	option = {
		name = amaryllian.900.c
		trigger = {
			OR = {
				has_planet_flag = amaryllian_farming_arcology
				owner = {
					OR = {
						country_uses_food = yes
						has_ascension_perk = ap_synthetic_evolution
					}
				}
			}
		}
		allow = {
			custom_tooltip_fail = {
				text = amaryllian_decision_grand_arcology_project_queued
				NOT = {
					has_planet_flag = amaryllian_decision_grand_arcology_project_queued
				}
			}
		}
		hidden_effect = {
			if = {
				limit = {
					NOR = {
						has_planet_flag = amaryllian_decision_grand_arcology_designer_locked
						check_variable = {
							which = "amaryllian_arcology_setup_num"
							value >= 4
						}
						has_planet_flag = amaryllian_farming_arcology_setup
					}
					OR = {
						has_planet_flag = amaryllian_farming_arcology
						owner = {
							has_technology = amaryllian_tech_farming_industry
						}
					}
				}
				set_planet_flag = amaryllian_farming_arcology_setup
				change_variable = {
					which = amaryllian_arcology_setup_num
					value = 1
				}
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
			else = {
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
		}
	}
	#	fortress
	option = {
		name = amaryllian.900.d
		allow = {
			custom_tooltip_fail = {
				text = amaryllian_decision_grand_arcology_project_queued
				NOT = {
					has_planet_flag = amaryllian_decision_grand_arcology_project_queued
				}
			}
		}
		hidden_effect = {
			if = {
				limit = {
					NOR = {
						has_planet_flag = amaryllian_decision_grand_arcology_designer_locked
						check_variable = {
							which = "amaryllian_arcology_setup_num"
							value >= 4
						}
						has_planet_flag = amaryllian_fortress_arcology_setup
					}
					OR = {
						has_planet_flag = amaryllian_fortress_arcology
						owner = {
							has_technology = amaryllian_tech_fortress_industry
						}
					}
				}
				set_planet_flag = amaryllian_fortress_arcology_setup
				change_variable = {
					which = amaryllian_arcology_setup_num
					value = 1
				}
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
			else = {
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
		}
	}
	#	research
	option = {
		name = amaryllian.900.e
		allow = {
			custom_tooltip_fail = {
				text = amaryllian_decision_grand_arcology_project_queued
				NOT = {
					has_planet_flag = amaryllian_decision_grand_arcology_project_queued
				}
			}
		}
		hidden_effect = {
			if = {
				limit = {
					NOR = {
						has_planet_flag = amaryllian_decision_grand_arcology_designer_locked
						check_variable = {
							which = "amaryllian_arcology_setup_num"
							value >= 4
						}
						has_planet_flag = amaryllian_research_arcology_setup
					}
					OR = {
						has_planet_flag = amaryllian_research_arcology
						owner = {
							has_technology = amaryllian_tech_research_industry
						}
					}
				}
				set_planet_flag = amaryllian_research_arcology_setup
				change_variable = {
					which = amaryllian_arcology_setup_num
					value = 1
				}
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
			else = {
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
		}
	}
	#	bureaucratic
	option = {
		name = amaryllian.900.f
		allow = {
			custom_tooltip_fail = {
				text = amaryllian_decision_grand_arcology_project_queued
				NOT = {
					has_planet_flag = amaryllian_decision_grand_arcology_project_queued
				}
			}
		}
		hidden_effect = {
			if = {
				limit = {
					NOT = {
						has_planet_flag = amaryllian_decision_grand_arcology_designer_locked
					}
					OR = {
						has_planet_flag = amaryllian_bureaucratic_arcology
						owner = {
							has_technology = amaryllian_tech_bureaucratic_industry
						}
					}
					NOR = {
						check_variable = {
							which = "amaryllian_arcology_setup_num"
							value >= 4
						}
						has_planet_flag = amaryllian_bureaucratic_arcology_setup
					}
				}
				set_planet_flag = amaryllian_bureaucratic_arcology_setup
				change_variable = {
					which = amaryllian_arcology_setup_num
					value = 1
				}
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
			else = {
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
		}
	}
	#	refinery
	option = {
		name = amaryllian.900.g
		allow = {
			custom_tooltip_fail = {
				text = amaryllian_decision_grand_arcology_project_queued
				NOT = {
					has_planet_flag = amaryllian_decision_grand_arcology_project_queued
				}
			}
		}
		hidden_effect = {
			if = {
				limit = {
					NOT = {
						has_planet_flag = amaryllian_decision_grand_arcology_designer_locked
					}
					OR = {
						has_planet_flag = amaryllian_refinery_arcology
						owner = {
							has_technology = amaryllian_tech_refinery_industry
							OR = {
								has_technology = "tech_volatile_motes"
								has_technology = "tech_rare_crystals"
								has_technology = "tech_exotic_gases"
							}
						}
					}
					NOR = {
						check_variable = {
							which = "amaryllian_arcology_setup_num"
							value >= 4
						}
						has_planet_flag = amaryllian_refinery_arcology_setup
					}
				}
				set_planet_flag = amaryllian_refinery_arcology_setup
				change_variable = {
					which = amaryllian_arcology_setup_num
					value = 1
				}
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
			else = {
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
		}
	}
	#	trade
	option = {
		name = amaryllian.900.h
		allow = {
			custom_tooltip_fail = {
				text = amaryllian_decision_grand_arcology_project_queued
				NOT = {
					has_planet_flag = amaryllian_decision_grand_arcology_project_queued
				}
			}
		}
		trigger = {
			OR = {
				has_planet_flag = amaryllian_trade_arcology
				owner = {
					is_gestalt = no
				}
			}
		}
		hidden_effect = {
			if = {
				limit = {
					NOR = {
						has_planet_flag = amaryllian_decision_grand_arcology_designer_locked
						check_variable = {
							which = "amaryllian_arcology_setup_num"
							value >= 4
						}
						has_planet_flag = amaryllian_trade_arcology_setup
					}
					OR = {
						has_planet_flag = amaryllian_trade_arcology
						owner = {
							has_technology = amaryllian_tech_trade_industry
						}
					}
				}
				set_planet_flag = amaryllian_trade_arcology_setup
				change_variable = {
					which = amaryllian_arcology_setup_num
					value = 1
				}
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
			else = {
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
		}
	}
	#	mining
	option = {
		name = amaryllian.900.i
		allow = {
			custom_tooltip_fail = {
				text = amaryllian_decision_grand_arcology_project_queued
				NOT = {
					has_planet_flag = amaryllian_decision_grand_arcology_project_queued
				}
			}
		}
		trigger = {
			OR = {
				has_planet_flag = amaryllian_mining_arcology
				has_planet_flag = mining_habitat
				# Planetary Diversity - Planetary Habitats
				has_planet_flag = pd_mining_hab
				has_planet_flag = pd_mining2_hab
			}
		}
		hidden_effect = {
			if = {
				limit = {
					NOR = {
						has_planet_flag = amaryllian_decision_grand_arcology_designer_locked
						check_variable = {
							which = "amaryllian_arcology_setup_num"
							value >= 4
						}
						has_planet_flag = amaryllian_mining_arcology_setup
					}
					OR = {
						has_planet_flag = amaryllian_mining_arcology
						owner = {
							has_technology = amaryllian_tech_mining_industry
						}
					}
				}
				set_planet_flag = amaryllian_mining_arcology_setup
				change_variable = {
					which = amaryllian_arcology_setup_num
					value = 1
				}
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
			else = {
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
		}
	}
	#	generator
	option = {
		name = amaryllian.900.j
		allow = {
			custom_tooltip_fail = {
				text = amaryllian_decision_grand_arcology_project_queued
				NOT = {
					has_planet_flag = amaryllian_decision_grand_arcology_project_queued
				}
			}
		}
		trigger = {
			OR = {
				owner = {
					is_gestalt = yes
				}
				has_planet_flag = amaryllian_generator_arcology
				has_planet_flag = energy_habitat
				# Planetary Diversity - Planetary Habitats
				has_planet_flag = pd_energy_hab
				has_planet_flag = pd_energy2_hab
			}
		}
		hidden_effect = {
			if = {
				limit = {
					NOR = {
						has_planet_flag = amaryllian_decision_grand_arcology_designer_locked
						check_variable = {
							which = "amaryllian_arcology_setup_num"
							value >= 4
						}
						has_planet_flag = amaryllian_generator_arcology_setup
					}
					OR = {
						has_planet_flag = amaryllian_generator_arcology
						owner = {
							has_technology = amaryllian_tech_generator_industry
						}
					}
				}
				set_planet_flag = amaryllian_generator_arcology_setup
				change_variable = {
					which = amaryllian_arcology_setup_num
					value = 1
				}
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
			else = {
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
		}
	}
	#	sanctuary
	option = {
		name = amaryllian.900.k
		allow = {
			custom_tooltip_fail = {
				text = amaryllian_decision_grand_arcology_project_queued
				NOT = {
					has_planet_flag = amaryllian_decision_grand_arcology_project_queued
				}
			}
		}
		trigger = {
			OR = {
				has_planet_flag = amaryllian_sanctuary_arcology
				owner = {
					has_valid_civic = civic_machine_servitor
				}
			}
		}
		hidden_effect = {
			if = {
				limit = {
					NOR = {
						has_planet_flag = amaryllian_decision_grand_arcology_designer_locked
						check_variable = {
							which = "amaryllian_arcology_setup_num"
							value >= 4
						}
						has_planet_flag = amaryllian_sanctuary_arcology_setup
					}
					OR = {
						has_planet_flag = amaryllian_sanctuary_arcology
						owner = {
							has_technology = amaryllian_tech_sanctuary_industry
						}
					}
				}
				set_planet_flag = amaryllian_sanctuary_arcology_setup
				change_variable = {
					which = amaryllian_arcology_setup_num
					value = 1
				}
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
			else = {
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
		}
	}
	#	storage
	option = {
		name = amaryllian.900.l
		allow = {
			custom_tooltip_fail = {
				text = amaryllian_decision_grand_arcology_project_queued
				NOT = {
					has_planet_flag = amaryllian_decision_grand_arcology_project_queued
				}
			}
		}
		hidden_effect = {
			if = {
				limit = {
					NOR = {
						has_planet_flag = amaryllian_decision_grand_arcology_designer_locked
						check_variable = {
							which = "amaryllian_arcology_setup_num"
							value >= 4
						}
						has_planet_flag = amaryllian_storage_arcology_setup
					}
					OR = {
						has_planet_flag = amaryllian_storage_arcology
						owner = {
							has_technology = amaryllian_tech_storage_industry
						}
					}
				}
				set_planet_flag = amaryllian_storage_arcology_setup
				change_variable = {
					which = amaryllian_arcology_setup_num
					value = 1
				}
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
			else = {
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
				break = yes
			}
		}
	}
	#	Clear
	option = {
		name = amaryllian.900.x
		allow = {
			custom_tooltip_fail = {
				text = amaryllian_decision_grand_arcology_project_queued
				NOT = {
					has_planet_flag = amaryllian_decision_grand_arcology_project_queued
				}
			}
		}
		hidden_effect = {
			if = {
				limit = {
					NOT = {
						has_planet_flag = amaryllian_decision_grand_arcology_designer_locked
					}
				}
				set_variable = {
					which = amaryllian_arcology_setup_num
					value = 0
				}
				remove_planet_flag = amaryllian_arms_arcology_setup
				remove_planet_flag = amaryllian_civilian_arcology_setup
				remove_planet_flag = amaryllian_farming_arcology_setup
				remove_planet_flag = amaryllian_fortress_arcology_setup
				remove_planet_flag = amaryllian_research_arcology_setup
				remove_planet_flag = amaryllian_bureaucratic_arcology_setup
				remove_planet_flag = amaryllian_refinery_arcology_setup
				remove_planet_flag = amaryllian_trade_arcology_setup
				remove_planet_flag = amaryllian_mining_arcology_setup
				remove_planet_flag = amaryllian_generator_arcology_setup
				remove_planet_flag = amaryllian_sanctuary_arcology_setup
				remove_planet_flag = amaryllian_storage_arcology_setup
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
			}
			else = {
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
			}
		}
	}
	#	Lock
	option = {
		name = amaryllian.900.y
		allow = {
			custom_tooltip_fail = {
				text = amaryllian_decision_grand_arcology_project_queued
				NOT = {
					has_planet_flag = amaryllian_decision_grand_arcology_project_queued
				}
			}
		}
		hidden_effect = {
			if = {
				limit = {
					NOT = {
						has_planet_flag = amaryllian_decision_grand_arcology_designer_locked
					}
					OR = {
						check_variable = {
							which = amaryllian_arcology_setup_num
							value = 1
						}
						AND = {
							owner = {
								has_ascension_perk = ap_amaryllian_voidchildren
							}
							check_variable = {
								which = amaryllian_arcology_setup_num
								value = 4
							}
						}
					}
				}
				set_timed_planet_flag = {
					flag = amaryllian_decision_grand_arcology_designer_locked
					days = 30
				}
				planet_event = {
					id = amaryllian.900
					days = 0
					random = 0
				}
			}
			else = {
				remove_planet_flag = amaryllian_decision_grand_arcology_designer_locked
				planet_event = {
					id = amaryllian.900
					days = 0
				}
			}
		}
	}
	#	Save
	option = {
		name = amaryllian.900.z
	}
}

# Dummy event to reduce error.log. Do not use!
event = {
	id = amaryllian.950
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		set_planet_flag = amaryllian_voidchildren		# Use this flag if you want to implement compatibility.
		set_planet_flag = amaryllian_arcology_allowed		#	Apply this flag to a planet to allow arcology project.
		set_planet_flag = voiddwellerstraitsfix
		set_planet_flag = stpg_planetary_habitat
		set_planet_flag = hab_init
		set_planet_flag = pdhab
		set_planet_flag = pd_mining_hab
		set_planet_flag = pd_mining2_hab
		set_planet_flag = pd_energy_hab
		set_planet_flag = pd_energy2_hab
		set_country_flag = EGS_START_STARBORN
		set_country_flag = starborn_origin
		set_country_flag = amaryllian_ignore_habitability_change
		set_planet_flag = forbid_guillis_planet_modifiers
		set_planet_flag = pd_ignore
	}
}
